<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W6D2: Logical Flaws & Area of Polygons</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <header id="lesson-header"></header>
        <div id="lesson-deck"></div>
        <div id="results-screen" style="display: none;"></div>
    </div>

    <script>
        const lessonData = {
            title: "Mission: Flaws & Formulas",
            subtitle: "Week 6, Day 2",
            pointsPerQuestion: 10,
            completion_id: 'w6d2',
            steps: [
                {
                    type: 'briefing',
                    header: 'Briefing: Flaws & Formulas',
                    content: `
                        <p>Agent, today we sharpen our critical eye and expand our geometric toolkit.</p>
                        <ul>
                            <li><strong>ELA:</strong> We will focus on identifying <strong>Logical Flaws</strong>. You will need to spot common errors in arguments, such as false dichotomies and ad hominem attacks.</li>
                            <li><strong>Math:</strong> We move on to calculating the <strong>Area of Polygons</strong>, including triangles, parallelograms, and trapezoids.</li>
                        </ul>
                        <p>Memorize the formulas and scrutinize the logic. Begin.</p>
                    `
                },
                // ELA Questions
                {
                    type: 'mcq',
                    header: 'ELA Question 1: Logical Flaw',
                    passage: 'My opponent argues that we need to spend more on education, but he is a terrible dresser and has a weird laugh. We can\'t trust his judgment on the budget.',
                    prompt: 'What is the primary logical flaw in this argument?',
                    options: [
                        'Hasty Generalization',
                        'Ad Hominem',
                        'Straw Man',
                        'Appeal to Authority'
                    ],
                    correctAnswer: 'Ad Hominem',
                    explanation: 'This is a classic ad hominem fallacy. The speaker attacks the opponent\'s character and appearance instead of addressing the actual substance of their argument about education funding.'
                },
                {
                    type: 'mcq',
                    header: 'ELA Question 2: Logical Flaw',
                    passage: 'We can either cut all funding for the arts program or watch our city go bankrupt. There is no other choice.',
                    prompt: 'This statement is an example of what logical flaw?',
                    options: [
                        'Slippery Slope',
                        'Circular Reasoning',
                        'False Dichotomy (or False Dilemma)',
                        'Bandwagon Appeal'
                    ],
                    correctAnswer: 'False Dichotomy (or False Dilemma)',
                    explanation: 'This is a false dichotomy because it presents only two extreme options as if they are the only possibilities, when in reality, there could be many other solutions (e.g., partial cuts, alternative funding, etc.).'
                },
                {
                    type: 'mcq',
                    header: 'ELA Question 3: Logical Flaw',
                    passage: 'I saw three students from North High School drop litter in the park. Therefore, all students from North High School are messy and disrespectful.',
                    prompt: 'What logical flaw does this reasoning contain?',
                    options: [
                        'Hasty Generalization',
                        'Post Hoc Ergo Propter Hoc',
                        'Ad Hominem',
                        'Appeal to Ignorance'
                    ],
                    correctAnswer: 'Hasty Generalization',
                    explanation: 'The speaker is drawing a broad conclusion about an entire group ("all students from North High School") based on a very small and insufficient sample size (three students).'
                },
                {
                    type: 'mcq',
                    header: 'ELA Question 4: Logical Flaw',
                    passage: 'Everyone is buying the new "Jump" sneakers, so they must be the best shoes available.',
                    prompt: 'The reasoning in this sentence is flawed because it is a(n):',
                    options: [
                        'Slippery Slope argument',
                        'Bandwagon Appeal',
                        'Straw Man argument',
                        'Circular Reasoning'
                    ],
                    correctAnswer: 'Bandwagon Appeal',
                    explanation: 'This is a bandwagon appeal, which argues that something must be true or good simply because it is popular. The popularity of a product does not necessarily equate to its quality.'
                },
                // Math Questions
                {
                    type: 'grid-in',
                    header: 'Math Question 1: Area of a Triangle',
                    prompt: 'A triangle has a base of 10 cm and a height of 6 cm. What is its area in square cm?',
                    correctAnswer: '30',
                    explanation: 'The formula for the area of a triangle is (1/2) * base * height. So, Area = (1/2) * 10 * 6 = 30 cm^2.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 2: Area of a Parallelogram',
                    prompt: 'A parallelogram has a base of 15 inches and a height of 4 inches. What is its area?',
                    correctAnswer: '60',
                    explanation: 'The area of a parallelogram is base * height. So, Area = 15 * 4 = 60 square inches. Do not be distracted by the slant height.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 3: Area of a Trapezoid',
                    prompt: 'A trapezoid has parallel bases of length 8 feet and 12 feet, and a height of 5 feet. What is its area?',
                    correctAnswer: '50',
                    explanation: 'The formula for the area of a trapezoid is ((base1 + base2) / 2) * height. So, Area = ((8 + 12) / 2) * 5 = (20 / 2) * 5 = 10 * 5 = 50 square feet.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 4: Finding a Missing Dimension',
                    prompt: 'A triangle has an area of 48 square meters and a base of 12 meters. What is its height?',
                    correctAnswer: '8',
                    explanation: 'Use the area formula: Area = (1/2) * base * height. So, 48 = (1/2) * 12 * h. This simplifies to 48 = 6h. Divide by 6: h = 8 meters.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 5: Area of a Regular Hexagon',
                    prompt: 'A regular hexagon is made up of 6 equilateral triangles. If one side of the hexagon is 4 cm, and the height of one of the equilateral triangles is approximately 3.5 cm, what is the approximate area of the hexagon?',
                    correctAnswer: '42',
                    explanation: 'First, find the area of one equilateral triangle: Area = (1/2) * base * height = (1/2) * 4 * 3.5 = 7 cm^2. Since a regular hexagon is made of 6 of these triangles, the total area is 6 * 7 = 42 cm^2.'
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const lessonHeader = document.getElementById('lesson-header');
            const lessonDeck = document.getElementById('lesson-deck');
            const resultsScreen = document.getElementById('results-screen');
            const completionId = lessonData.completion_id;

            let currentStep = 0;
            let score = 0;
            let completedAnswers = new Map();

            function startLesson() {
                lessonHeader.innerHTML = `<h1>${lessonData.title}</h1><p>${lessonData.subtitle}</p>`;
                showStep(currentStep);
            }

            function showStep(stepIndex) {
                const step = lessonData.steps[stepIndex];
                if (!step) return;

                let content = '';
                if (step.type === 'briefing') {
                    content = `
                        <div class="card briefing-card">
                            <h2>${step.header}</h2>
                            ${step.content}
                            <button id="next-btn">Start Mission</button>
                        </div>
                    `;
                } else if (step.type === 'mcq') {
                    const optionsHtml = step.options.map((option, index) => {
                        const isSelected = completedAnswers.has(stepIndex) && completedAnswers.get(stepIndex).answer === option;
                        return `<button class="option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">${option}</button>`;
                    }).join('');
                    content = `
                        <div class="card">
                            <h2>${step.header}</h2>
                            ${step.passage ? `<div class="passage">${step.passage}</div>` : ''}
                            <p class="prompt">${step.prompt}</p>
                            <div class="mcq-options">${optionsHtml}</div>
                            <div class="feedback"></div>
                        </div>
                    `;
                } else if (step.type === 'grid-in') {
                    const savedAnswer = completedAnswers.has(stepIndex) ? completedAnswers.get(stepIndex).answer : '';
                    content = `
                        <div class="card">
                            <h2>${step.header}</h2>
                            ${step.passage ? `<div class="passage">${step.passage}</div>` : ''}
                            <p class="prompt">${step.prompt}</p>
                            <input type="text" class="grid-in-input" value="${savedAnswer}">
                            <button class="submit-btn">Submit</button>
                            <div class="feedback"></div>
                        </div>
                    `;
                } else if (step.type === 'scrambled-paragraph') {
                    let sentences = [...step.sentences]; // Make a copy
                    if (completedAnswers.has(stepIndex)) {
                        const savedOrder = completedAnswers.get(stepIndex).answer;
                        sentences = savedOrder.map(text => step.sentences.find(s => s.text === text));
                    } else {
                        // Fisher-Yates shuffle
                        for (let i = sentences.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [sentences[i], sentences[j]] = [sentences[j], sentences[i]];
                        }
                    }

                    const sentencesHtml = sentences.map(sentence =>
                        `<div class="scrambled-sentence" draggable="true" data-id="${sentence.id}">${sentence.text}</div>`
                    ).join('');

                    content = `
                        <div class="card">
                            <h2>${step.header}</h2>
                            <p class="prompt">${step.prompt}</p>
                            <div class="scramble-container">${sentencesHtml}</div>
                            <button class="submit-btn">Check Order</button>
                            <div class="feedback"></div>
                        </div>
                    `;
                }

                lessonDeck.innerHTML = content;
                addCardEventListeners();
            }

            function addCardEventListeners() {
                // For MCQ
                lessonDeck.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleMcqSelection(btn));
                });

                // For Grid-in or Scrambled Paragraph
                const submitBtn = lessonDeck.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.addEventListener('click', () => {
                        const stepType = lessonData.steps[currentStep].type;
                        if (stepType === 'grid-in') {
                            handleGridInSubmission();
                        } else if (stepType === 'scrambled-paragraph') {
                            handleScrambledParagraphSubmission();
                        }
                    });
                }
                
                // For Scrambled Paragraph Drag and Drop
                const container = lessonDeck.querySelector('.scramble-container');
                if (container) {
                    let draggedItem = null;
                    container.addEventListener('dragstart', e => {
                        draggedItem = e.target;
                        setTimeout(() => e.target.style.display = 'none', 0);
                    });
                    container.addEventListener('dragend', e => {
                        setTimeout(() => {
                            if(e.target) e.target.style.display = '';
                            draggedItem = null;
                        }, 0);
                    });
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        const afterElement = getDragAfterElement(container, e.clientY);
                        if (afterElement == null) {
                            container.appendChild(draggedItem);
                        } else {
                            container.insertBefore(draggedItem, afterElement);
                        }
                    });
                }


                // For "Next" button on briefing
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', showNextStep);
                }
            }
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.scrambled-sentence:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function handleMcqSelection(selectedButton) {
                if (completedAnswers.has(currentStep)) return;

                const selectedAnswer = selectedButton.dataset.option;
                const correct = selectedAnswer === lessonData.steps[currentStep].correctAnswer;
                
                showFeedback(correct, lessonData.steps[currentStep].explanation);
                
                if (correct) {
                    score += lessonData.pointsPerQuestion;
                }
                completedAnswers.set(currentStep, { answer: selectedAnswer, correct: correct });

                lessonDeck.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if(btn.dataset.option === lessonData.steps[currentStep].correctAnswer) {
                        btn.classList.add('correct');
                    } else if (btn === selectedButton) {
                        btn.classList.add('incorrect');
                    }
                });
            }

            function handleGridInSubmission() {
                if (completedAnswers.has(currentStep)) return;

                const input = lessonDeck.querySelector('.grid-in-input');
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = String(lessonData.steps[currentStep].correctAnswer).toLowerCase();
                const correct = userAnswer === correctAnswer;

                showFeedback(correct, lessonData.steps[currentStep].explanation);

                if (correct) {
                    score += lessonData.pointsPerQuestion;
                    input.classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                }
                input.disabled = true;
                completedAnswers.set(currentStep, { answer: input.value, correct: correct });
            }
            
            function handleScrambledParagraphSubmission() {
                if (completedAnswers.has(currentStep)) return;

                const container = lessonDeck.querySelector('.scramble-container');
                const submittedSentences = [...container.querySelectorAll('.scrambled-sentence')];
                const submittedOrder = submittedSentences.map(s => parseInt(s.dataset.id));
                const correctOrder = lessonData.steps[currentStep].sentences.map(s => s.id);
                
                let correct = JSON.stringify(submittedOrder) === JSON.stringify(correctOrder);
                
                showFeedback(correct, lessonData.steps[currentStep].explanation);
                
                 if (correct) {
                    score += lessonData.pointsPerQuestion;
                }
                const savedAnswer = submittedSentences.map(s => s.textContent);
                completedAnswers.set(currentStep, { answer: savedAnswer, correct: correct });
                
                submittedSentences.forEach(el => el.setAttribute('draggable', 'false'));
            }


            function showFeedback(isCorrect, explanation) {
                const feedbackDiv = lessonDeck.querySelector('.feedback');
                let feedbackHtml = `
                    <div class="feedback-content ${isCorrect ? 'correct-feedback' : 'incorrect-feedback'}">
                        <p><strong>${isCorrect ? 'Correct!' : 'Incorrect.'}</strong></p>
                        <p>${explanation}</p>
                        <button id="feedback-next-btn">Next</button>
                    </div>`;
                feedbackDiv.innerHTML = feedbackHtml;
                feedbackDiv.style.display = 'block';
                const feedbackBtn = document.getElementById('feedback-next-btn');
                if(feedbackBtn) feedbackBtn.addEventListener('click', showNextStep);
            }

            function showNextStep() {
                currentStep++;
                if (currentStep < lessonData.steps.length) {
                    showStep(currentStep);
                } else {
                    showResults();
                }
            }

            function showResults() {
                lessonDeck.style.display = 'none';
                resultsScreen.style.display = 'block';
                const totalQuestions = lessonData.steps.filter(s => s.type !== 'briefing').length;
                const percentage = totalQuestions > 0 ? Math.round((score / (totalQuestions * lessonData.pointsPerQuestion)) * 100) : 0;
                
                resultsScreen.innerHTML = `
                    <div class="card results-card">
                        <h2>Mission Complete!</h2>
                        <p>You scored ${score} out of ${totalQuestions * lessonData.pointsPerQuestion} (${percentage}%)</p>
                        <button onclick="window.location.href='../index.html'">Return to Dashboard</button>
                    </div>
                `;
                markLessonComplete();
            }

            function markLessonComplete() {
                 let completed = new Set(JSON.parse(localStorage.getItem('completedLessons')) || []);
                 completed.add(completionId);
                 localStorage.setItem('completedLessons', JSON.stringify([...completed]));
            }

            startLesson();
        });
    </script>
</body>
</html> 