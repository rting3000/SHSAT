<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W5D3: Advanced Revising & Equations</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <header id="lesson-header"></header>
        <div id="lesson-deck"></div>
        <div id="results-screen" style="display: none;"></div>
    </div>

    <script>
        const lessonData = {
            title: "Mission: Advanced Revising & Equations",
            subtitle: "Week 5, Day 3",
            pointsPerQuestion: 10,
            completion_id: 'w5d3',
            steps: [
                {
                    type: 'briefing',
                    header: 'Briefing: Building Mastery',
                    content: `
                        <p>Agent, today we solidify our understanding of this week's topics.</p>
                        <ul>
                            <li><strong>ELA:</strong> We'll tackle more nuanced <strong>Revising and Editing</strong> tasks, focusing on style, tone, and logical flow.</li>
                            <li><strong>Math:</strong> You'll face more complex <strong>Linear Equations</strong>, including those with variables on both sides and fractional coefficients.</li>
                        </ul>
                        <p>Precision is everything. Proceed.</p>
                    `
                },
                // ELA Questions
                {
                    type: 'mcq',
                    header: 'ELA Question 1: Sentence Placement',
                    passage: '(1) The kangaroo is a marsupial from Australia. (2) It is known for its powerful hind legs, which it uses to hop at high speeds. (3) These animals are herbivores, primarily eating grasses and shrubs. (4) Kangaroos also have a pouch, called a marsupium, where their young, known as joeys, complete their development.',
                    prompt: 'Where would the following sentence best be placed? "This pouch is a defining characteristic of most marsupials."',
                    options: [
                        'Before sentence (1)',
                        'After sentence (2)',
                        'After sentence (4)',
                        'It should not be added.'
                    ],
                    correctAnswer: 'After sentence (4)',
                    explanation: 'Sentence (4) introduces the pouch (marsupium). The new sentence logically follows by explaining the significance of the pouch to the larger class of animals (marsupials).'
                },
                {
                    type: 'mcq',
                    header: 'ELA Question 2: Tone',
                    passage: 'This old house is a real dump. The paint is peeling, the roof leaks, and I think I saw a ghost. I can\'t believe someone would actually pay money to live in this wreck.',
                    prompt: 'Which word best describes the tone of this passage?',
                    options: ['Formal', 'Optimistic', 'Sarcastic', 'Disgusted'],
                    correctAnswer: 'Disgusted',
                    explanation: 'The author uses strong negative words ("dump," "wreck") and complains about multiple problems, expressing a clear feeling of disgust and contempt for the house.'
                },
                {
                    type: 'mcq',
                    header: 'ELA Question 3: Redundancy',
                    passage: 'The annual yearly festival attracts visitors from all over the world.',
                    prompt: 'Which word is redundant and should be removed?',
                    options: ['annual', 'yearly', 'festival', 'visitors'],
                    correctAnswer: 'yearly',
                    explanation: '"Annual" and "yearly" mean the same thing (occurring once a year). Using both is redundant. Removing either one would make the sentence more concise.'
                },
                {
                    type: 'mcq',
                    header: 'ELA Question 4: Combining Sentences',
                    passage: 'The Sahara is the largest hot desert in the world. It covers most of North Africa.',
                    prompt: 'What is the best way to combine these sentences?',
                    options: [
                        'The Sahara, the largest hot desert in the world, covers most of North Africa.',
                        'The Sahara is the largest hot desert in the world, and it covers most of North Africa.',
                        'The Sahara covers most of North Africa and is the largest hot desert in the world.',
                        'Covering most of North Africa, the Sahara is the largest hot desert in the world.'
                    ],
                    correctAnswer: 'The Sahara, the largest hot desert in the world, covers most of North Africa.',
                    explanation: 'This option uses an appositive phrase ("the largest hot desert in the world") to concisely combine the two ideas into a single, elegant sentence.'
                },
                // Math Questions
                {
                    type: 'grid-in',
                    header: 'Math Question 1: Equations with Variables on Both Sides',
                    prompt: 'Solve for x: 7x + 5 = 4x - 10',
                    correctAnswer: '-5',
                    explanation: 'Subtract 4x from both sides: 3x + 5 = -10. Subtract 5 from both sides: 3x = -15. Divide by 3: x = -5.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 2: Equations with Parentheses',
                    prompt: 'Solve for p: 5(p - 3) = 3(p + 1)',
                    correctAnswer: '9',
                    explanation: 'Distribute on both sides: 5p - 15 = 3p + 3. Subtract 3p from both sides: 2p - 15 = 3. Add 15 to both sides: 2p = 18. Divide by 2: p = 9.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 3: Fractional Coefficients',
                    prompt: 'Solve for k: (1/2)k + 5 = (3/4)k',
                    correctAnswer: '20',
                    explanation: 'To eliminate fractions, multiply every term by the least common denominator, which is 4. This gives: 2k + 20 = 3k. Subtract 2k from both sides: 20 = k.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 4: Word Problem',
                    prompt: 'A rental car company charges $30 per day plus $0.25 per mile. If a person paid $90 for a one-day rental, how many miles did they drive?',
                    correctAnswer: '240',
                    explanation: 'Let m be the number of miles. The equation is 30 + 0.25m = 90. Subtract 30 from both sides: 0.25m = 60. Divide by 0.25 (which is the same as multiplying by 4): m = 240 miles.'
                },
                {
                    type: 'grid-in',
                    header: 'Math Question 5: Inequality with Distribution',
                    prompt: 'Solve for x: -2(x - 4) > 10. What is the largest integer solution for x?',
                    correctAnswer: '-2',
                    explanation: 'Distribute the -2: -2x + 8 > 10. Subtract 8 from both sides: -2x > 2. Divide by -2 and flip the inequality sign: x < -1. The largest integer less than -1 is -2.'
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const lessonHeader = document.getElementById('lesson-header');
            const lessonDeck = document.getElementById('lesson-deck');
            const resultsScreen = document.getElementById('results-screen');
            const completionId = lessonData.completion_id;

            let currentStep = 0;
            let score = 0;
            let completedAnswers = new Map();

            function startLesson() {
                lessonHeader.innerHTML = `<h1>${lessonData.title}</h1><p>${lessonData.subtitle}</p>`;
                showStep(currentStep);
            }

            function showStep(stepIndex) {
                const step = lessonData.steps[stepIndex];
                if (!step) return;

                let content = '';
                if (step.type === 'briefing') {
                    content = `
                        <div class="card briefing-card">
                            <h2>${step.header}</h2>
                            ${step.content}
                            <button id="next-btn">Start Mission</button>
                        </div>
                    `;
                } else if (step.type === 'mcq') {
                    const optionsHtml = step.options.map((option, index) => {
                        const isSelected = completedAnswers.has(stepIndex) && completedAnswers.get(stepIndex).answer === option;
                        return `<button class="option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">${option}</button>`;
                    }).join('');
                    content = `
                        <div class="card">
                            <h2>${step.header}</h2>
                            ${step.passage ? `<div class="passage">${step.passage}</div>` : ''}
                            <p class="prompt">${step.prompt}</p>
                            <div class="mcq-options">${optionsHtml}</div>
                            <div class="feedback"></div>
                        </div>
                    `;
                } else if (step.type === 'grid-in') {
                    const savedAnswer = completedAnswers.has(stepIndex) ? completedAnswers.get(stepIndex).answer : '';
                    content = `
                        <div class="card">
                            <h2>${step.header}</h2>
                            ${step.passage ? `<div class="passage">${step.passage}</div>` : ''}
                            <p class="prompt">${step.prompt}</p>
                            <input type="text" class="grid-in-input" value="${savedAnswer}">
                            <button class="submit-btn">Submit</button>
                            <div class="feedback"></div>
                        </div>
                    `;
                } else if (step.type === 'scrambled-paragraph') {
                    let sentences = [...step.sentences]; // Make a copy
                    if (completedAnswers.has(stepIndex)) {
                        const savedOrder = completedAnswers.get(stepIndex).answer;
                        sentences = savedOrder.map(text => step.sentences.find(s => s.text === text));
                    } else {
                        // Fisher-Yates shuffle
                        for (let i = sentences.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [sentences[i], sentences[j]] = [sentences[j], sentences[i]];
                        }
                    }

                    const sentencesHtml = sentences.map(sentence =>
                        `<div class="scrambled-sentence" draggable="true" data-id="${sentence.id}">${sentence.text}</div>`
                    ).join('');

                    content = `
                        <div class="card">
                            <h2>${step.header}</h2>
                            <p class="prompt">${step.prompt}</p>
                            <div class="scramble-container">${sentencesHtml}</div>
                            <button class="submit-btn">Check Order</button>
                            <div class="feedback"></div>
                        </div>
                    `;
                }

                lessonDeck.innerHTML = content;
                addCardEventListeners();
            }

            function addCardEventListeners() {
                // For MCQ
                lessonDeck.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleMcqSelection(btn));
                });

                // For Grid-in or Scrambled Paragraph
                const submitBtn = lessonDeck.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.addEventListener('click', () => {
                        const stepType = lessonData.steps[currentStep].type;
                        if (stepType === 'grid-in') {
                            handleGridInSubmission();
                        } else if (stepType === 'scrambled-paragraph') {
                            handleScrambledParagraphSubmission();
                        }
                    });
                }
                
                // For Scrambled Paragraph Drag and Drop
                const container = lessonDeck.querySelector('.scramble-container');
                if (container) {
                    let draggedItem = null;
                    container.addEventListener('dragstart', e => {
                        draggedItem = e.target;
                        setTimeout(() => e.target.style.display = 'none', 0);
                    });
                    container.addEventListener('dragend', e => {
                        setTimeout(() => {
                            if(e.target) e.target.style.display = '';
                            draggedItem = null;
                        }, 0);
                    });
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        const afterElement = getDragAfterElement(container, e.clientY);
                        if (afterElement == null) {
                            container.appendChild(draggedItem);
                        } else {
                            container.insertBefore(draggedItem, afterElement);
                        }
                    });
                }


                // For "Next" button on briefing
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', showNextStep);
                }
            }
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.scrambled-sentence:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function handleMcqSelection(selectedButton) {
                if (completedAnswers.has(currentStep)) return;

                const selectedAnswer = selectedButton.dataset.option;
                const correct = selectedAnswer === lessonData.steps[currentStep].correctAnswer;
                
                showFeedback(correct, lessonData.steps[currentStep].explanation);
                
                if (correct) {
                    score += lessonData.pointsPerQuestion;
                }
                completedAnswers.set(currentStep, { answer: selectedAnswer, correct: correct });

                lessonDeck.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if(btn.dataset.option === lessonData.steps[currentStep].correctAnswer) {
                        btn.classList.add('correct');
                    } else if (btn === selectedButton) {
                        btn.classList.add('incorrect');
                    }
                });
            }

            function handleGridInSubmission() {
                if (completedAnswers.has(currentStep)) return;

                const input = lessonDeck.querySelector('.grid-in-input');
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = String(lessonData.steps[currentStep].correctAnswer).toLowerCase();
                const correct = userAnswer === correctAnswer;

                showFeedback(correct, lessonData.steps[currentStep].explanation);

                if (correct) {
                    score += lessonData.pointsPerQuestion;
                    input.classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                }
                input.disabled = true;
                completedAnswers.set(currentStep, { answer: input.value, correct: correct });
            }
            
            function handleScrambledParagraphSubmission() {
                if (completedAnswers.has(currentStep)) return;

                const container = lessonDeck.querySelector('.scramble-container');
                const submittedSentences = [...container.querySelectorAll('.scrambled-sentence')];
                const submittedOrder = submittedSentences.map(s => parseInt(s.dataset.id));
                const correctOrder = lessonData.steps[currentStep].sentences.map(s => s.id);
                
                let correct = JSON.stringify(submittedOrder) === JSON.stringify(correctOrder);
                
                showFeedback(correct, lessonData.steps[currentStep].explanation);
                
                 if (correct) {
                    score += lessonData.pointsPerQuestion;
                }
                const savedAnswer = submittedSentences.map(s => s.textContent);
                completedAnswers.set(currentStep, { answer: savedAnswer, correct: correct });
                
                submittedSentences.forEach(el => el.setAttribute('draggable', 'false'));
            }


            function showFeedback(isCorrect, explanation) {
                const feedbackDiv = lessonDeck.querySelector('.feedback');
                let feedbackHtml = `
                    <div class="feedback-content ${isCorrect ? 'correct-feedback' : 'incorrect-feedback'}">
                        <p><strong>${isCorrect ? 'Correct!' : 'Incorrect.'}</strong></p>
                        <p>${explanation}</p>
                        <button id="feedback-next-btn">Next</button>
                    </div>`;
                feedbackDiv.innerHTML = feedbackHtml;
                feedbackDiv.style.display = 'block';
                const feedbackBtn = document.getElementById('feedback-next-btn');
                if(feedbackBtn) feedbackBtn.addEventListener('click', showNextStep);
            }

            function showNextStep() {
                currentStep++;
                if (currentStep < lessonData.steps.length) {
                    showStep(currentStep);
                } else {
                    showResults();
                }
            }

            function showResults() {
                lessonDeck.style.display = 'none';
                resultsScreen.style.display = 'block';
                const totalQuestions = lessonData.steps.filter(s => s.type !== 'briefing').length;
                const percentage = totalQuestions > 0 ? Math.round((score / (totalQuestions * lessonData.pointsPerQuestion)) * 100) : 0;
                
                resultsScreen.innerHTML = `
                    <div class="card results-card">
                        <h2>Mission Complete!</h2>
                        <p>You scored ${score} out of ${totalQuestions * lessonData.pointsPerQuestion} (${percentage}%)</p>
                        <button onclick="window.location.href='../index.html'">Return to Dashboard</button>
                    </div>
                `;
                markLessonComplete();
            }

            function markLessonComplete() {
                 let completed = new Set(JSON.parse(localStorage.getItem('completedLessons')) || []);
                 completed.add(completionId);
                 localStorage.setItem('completedLessons', JSON.stringify([...completed]));
            }

            startLesson();
        });
    </script>
</body>
</html> 